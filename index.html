<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WoT Battle Tracker</title>
  <script src="https://unpkg.com/wotstat-widgets-sdk"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      color: #fff;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .tracker {
      background: #000;
      border: 2px solid #ffc107;
      border-radius: 1em;
      padding: 1rem;
      width: 320px;
      box-shadow: 0 0 20px rgba(255,193,7,0.5);
      text-align: center;
    }
    .tracker h2 {
      margin: 0 0 0.5rem;
      color: #ffc107;
    }
    .tracker p {
      margin: 0.3rem 0;
    }
  </style>
</head>
<body>
  <div class="tracker">
    <h2>WoT Battle Tracker</h2>
    <p>–ö—Ä–µ–¥–∏—Ç–∏: <span id="credits">0</span></p>
    <p>–ë–æ—ó: <span id="battles">0</span></p>
    <p>–ü–µ—Ä–µ–º–æ–≥–∏: <span id="wins">0</span></p>
  </div>

  <script type="module">
    import { WidgetSDK } from 'https://unpkg.com/wotstat-widgets-sdk?module';
    const sdk = new WidgetSDK();

    let totalCredits = 0;
    let battleCount = 0;
    let winCount = 0;

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt5kK9Vs7hVNevK4JY4YiubPdErlFpTi8JQ50i7AkeaKMKelBcJMQz40uol7rxiCtbpA/exec";

    function updateUI() {
      document.getElementById('credits').textContent = totalCredits.toLocaleString();
      document.getElementById('battles').textContent = battleCount;
      document.getElementById('wins').textContent = winCount;
    }

    function sendToSheet(payload) {
      const query = new URLSearchParams(payload).toString();
      const url = `${SCRIPT_URL}?${query}`;

      fetch(url)
        .then(res => res.text())
        .then(txt => console.log('üì• Sheet response:', txt))
        .catch(err => console.error('‚ùå Sheet error:', err));
    }

    sdk.data.battle.onBattleResult.watch(result => {
      if (!result || !result.personal || !result.players) return;

      const myId = sdk.data.player.id.value;
      const now = new Date();
      const mapName = sdk.data.map.name.value || '';

      let myEntries = [];

      for (const [pid, personal] of Object.entries(result.personal)) {
        const player = result.players[pid];
        if (!player || player.accountDBID !== myId) continue;

        myEntries.push({ pid, personal, player });
      }

      if (myEntries.length === 0) {
        console.warn("‚ùó –ù–µ–º–∞—î –æ—Å–æ–±–∏—Å—Ç–∏—Ö –¥–∞–Ω–∏—Ö —É —Ü—å–æ–º—É –±–æ—é.");
        return;
      }

      // –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
      battleCount++;

      const myTeamId = result.players?.[myId]?.team;
      const winner = result.common?.winnerTeam;
      const isWin = myTeamId && winner && parseInt(myTeamId) === parseInt(winner);
      if (isWin) winCount++;

      updateUI();

      myEntries.forEach(({ personal, player }) => {
        const tank = player.vehicleType || '‚Äî';
        const earned = personal.credits || 0;
        const repair = personal.autoRepairCost || 0;
        const equip = personal.autoEquipCost?.[0] || 0;
        const load = personal.autoLoadCost?.[0] || 0;
        const netCredits = earned - (repair + equip + load);
        const damage = personal.damageDealt || 0;
        const assist = (personal.damageAssisted || 0) + (personal.spottedAssisted || 0);

        totalCredits += netCredits;

        const payload = {
          time:    now.toLocaleString('uk-UA'),
          battle:  battleCount,
          tank:    tank,
          map:     mapName,
          win:     isWin ? '–ü–µ—Ä–µ–º–æ–≥–∞' : '–ü–æ—Ä–∞–∑–∫–∞',
          damage:  damage,
          assist:  assist,
          credits: netCredits
        };

        console.log("üì§ –ù–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è:", payload);
        sendToSheet(payload);
      });
    });
  </script>
</body>
</html>
